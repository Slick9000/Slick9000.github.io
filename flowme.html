<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Chart Planner</title>
    <style>
        body {
            font-family: monospace;
            background-color: #2c003e;
            color: white;
            margin: 0;
            display: flex;
            flex-direction: row;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            position: relative;
            overflow: hidden;
        }
        #canvas {
            position: relative;
            flex: 1;
            overflow: hidden;
            border: 2px solid #6a0dad;
        }
        .node {
            position: absolute;
            background-color: #6a0dad;
            border: 1px solid white;
            border-radius: 5px;
            padding: 10px;
            cursor: move;
            user-select: none;
        }
        .comment-section {
            width: 250px;
            background-color: #ff8fe3;
            padding: 10px;
            display: block;
            transition: background-color 0.3s;
        }
        .comment-section.hidden {
            display: none;
        }
        .comment-section input, .comment-section textarea {
            width: 100%;
            background-color: #6a0dad;
            color: white;
            border: none;
            margin-bottom: 10px;
            padding: 5px;
            font-size: 12px;
        }
        .instructions, .label, .checkbox-label {
            font-size: 12px;
            margin-top: 5px;
        }
        .color-picker {
            margin-top: 10px;
        }
        .reset-button {
            margin-top: 10px;
            padding: 5px;
            background-color: #ff4d4d;
            border: none;
            color: white;
            cursor: pointer;
        }
        #videoBackground {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            display: none;
        }
    </style>
</head>
<body>
    <div id="canvas"></div>
    <div class="comment-section" id="commentSection">
        <h3>Node Details</h3>
        <input type="text" id="nodeNameInput" placeholder="Node Name" />
        <textarea id="commentInput" placeholder="Add comments here... (or a YouTube link)"></textarea>
        <div class="instructions">
            Instructions:<br>
            - Double-click to create a new node.<br>
            - Left-click a node to open the sidebar and edit it.<br>
            - Left click and drag to move nodes around.<br>
            - Right-click a node to delete it.<br>
            - Middle-click a node to pause/play video if playing a YouTube link. (YouTube nodes are experimental)<br>
        </div>
        
        <div class="color-picker">
            <label class="label" for="nodeColor">Node Background Color:</label>
            <input type="color" id="nodeColor" value="#6a0dad">
        </div>
        <div class="color-picker">
            <label class="label" for="bodyColor">Body Background Color:</label>
            <input type="color" id="bodyColor" value="#2c003e">
        </div>
        <div class="color-picker">
            <label class="label" for="sidebarColor">Sidebar Color:</label>
            <input type="color" id="sidebarColor" value="#ff8fe3">
        </div>
        <div class="color-picker">
            <label class="label" for="textColor">Text Color:</label>
            <input type="color" id="textColor" value="#ffffff">
        </div>
        
        <div>
            <label class="label">Unique Node Colours</label>
            <label class="checkbox-label">
                <input type="checkbox" id="uniqueColorToggle" /> 
            </label>
        </div>

        <button class="reset-button" id="resetButton">Reset to Default Colors</button>
    </div>

    <iframe id="videoBackground" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

    <script>
        let nodes = [];
        const canvas = document.getElementById('canvas');
        const commentSection = document.getElementById('commentSection');
        const nodeNameInput = document.getElementById('nodeNameInput');
        const commentInput = document.getElementById('commentInput');
        let selectedNode = null;
        let uniqueNodeColors = false;
        const videoBackground = document.getElementById('videoBackground');
        let videoPlaying = false;

        // Default colors
        const defaultColors = {
            nodeColor: '#6a0dad',
            bodyColor: '#2c003e',
            sidebarColor: '#ff8fe3',
            textColor: '#ffffff'
        };

        function createNode(x, y, color) {
            const node = document.createElement('div');
            node.classList.add('node');
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            node.style.backgroundColor = color || defaultColors.nodeColor;
            node.innerText = 'New Node';
            node.draggable = true;

            node.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', null);
            });

            node.addEventListener('dragend', (e) => {
                const rect = canvas.getBoundingClientRect();
                node.style.left = (e.clientX - rect.left) + 'px';
                node.style.top = (e.clientY - rect.top) + 'px';
                updateNodePosition(node);
            });

            node.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                deleteNode(node);
            });

            node.addEventListener('click', () => {
                selectNode(node);
            });

            node.addEventListener('mousedown', (e) => {
                if (e.button === 1) { // Middle mouse button
                    toggleVideo(node);
                }
            });

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    selectedNode = null;
                    commentSection.classList.add('hidden');
                }
            });

            canvas.appendChild(node);
            nodes.push({ x, y, element: node });
        }

        function updateNodePosition(node) {
            const index = nodes.findIndex(n => n.element === node);
            if (index !== -1) {
                nodes[index].x = parseInt(node.style.left);
                nodes[index].y = parseInt(node.style.top);
            }
        }

        function selectNode(node) {
            selectedNode = node;
            nodeNameInput.value = node.innerText;
            commentInput.value = node.comment || '';
            commentSection.classList.remove('hidden');
            document.getElementById('nodeColor').value = rgbToHex(node.style.backgroundColor);
            checkForVideoLink(node.comment);
        }

        function deleteNode(node) {
            if (selectedNode === node) {
                selectedNode = null;
                commentSection.classList.add('hidden');
                stopVideoBackground();
            }
            nodes = nodes.filter(n => n.element !== node);
            node.remove();
        }

        nodeNameInput.addEventListener('input', () => {
            if (selectedNode) {
                selectedNode.innerText = nodeNameInput.value;
            }
        });

        commentInput.addEventListener('input', () => {
            if (selectedNode) {
                selectedNode.comment = commentInput.value;
                checkForVideoLink(commentInput.value);
            }
        });

        canvas.addEventListener('dblclick', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const color = uniqueNodeColors ? document.getElementById('nodeColor').value : defaultColors.nodeColor;
            createNode(x, y, color);
        });

        document.getElementById('uniqueColorToggle').addEventListener('change', (e) => {
            uniqueNodeColors = e.target.checked;
            updateNodeColor();
        });

        document.getElementById('nodeColor').addEventListener('input', updateNodeColor);

        function updateNodeColor() {
            const color = document.getElementById('nodeColor').value;
            if (!uniqueNodeColors) {
                nodes.forEach(node => {
                    node.element.style.backgroundColor = color;
                });
            } else if (selectedNode) {
                selectedNode.style.backgroundColor = color;
            }
        }

        document.getElementById('bodyColor').addEventListener('input', (e) => {
            document.body.style.backgroundColor = e.target.value;
        });

        document.getElementById('sidebarColor').addEventListener('input', (e) => {
            commentSection.style.backgroundColor = e.target.value;
        });

        document.getElementById('textColor').addEventListener('input', (e) => {
            document.body.style.color = e.target.value;
        });

        document.getElementById('resetButton').addEventListener('click', () => {
            nodes.forEach(node => {
                node.element.style.backgroundColor = defaultColors.nodeColor;
            });
            document.getElementById('nodeColor').value = defaultColors.nodeColor;
            document.getElementById('bodyColor').value = defaultColors.bodyColor;
            document.getElementById('sidebarColor').value = defaultColors.sidebarColor;
            document.getElementById('textColor').value = defaultColors.textColor;
            document.body.style.backgroundColor = defaultColors.bodyColor;
            commentSection.style.backgroundColor = defaultColors.sidebarColor;
            document.body.style.color = defaultColors.textColor;
            stopVideoBackground();
            uniqueNodeColors = false;
            document.getElementById('uniqueColorToggle').checked = false;
        });

        window.addEventListener('beforeunload', () => {
            localStorage.setItem('flowChartNodes', JSON.stringify(nodes));
        });

        window.addEventListener('load', () => {
            const savedNodes = localStorage.getItem('flowChartNodes');
            if (savedNodes) {
                nodes = JSON.parse(savedNodes);
                nodes.forEach(nodeData => {
                    createNode(nodeData.x, nodeData.y, nodeData.element.style.backgroundColor);
                    nodeData.element.innerText = nodeData.comment || 'New Node';
                });
            }
        });

        function rgbToHex(rgb) {
            const result = /^rgba?\((\d+),\s*(\d+),\s*(\d+)/.exec(rgb);
            return result ? '#' + ((1 << 24) + (parseInt(result[1]) << 16) + (parseInt(result[2]) << 8) + parseInt(result[3])).toString(16).slice(1) : rgb;
        }

        function checkForVideoLink(comment) {
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = comment.match(youtubeRegex);
            if (match) {
                const videoId = match[1];
                setVideoBackground(videoId);
            }
        }

        function setVideoBackground(videoId) {
            videoBackground.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=0&loop=1&playlist=${videoId}`;
            videoBackground.style.display = 'block';
            commentSection.classList.add('hidden'); // Hide sidebar when video plays
            videoPlaying = true;
        }

        function stopVideoBackground() {
            videoBackground.style.display = 'none';
            videoBackground.src = '';
            videoPlaying = false;
        }

        function toggleVideo(node) {
            if (videoPlaying) {
                stopVideoBackground();
            } else {
                selectNode(node);
            }
        }
    </script>
</body>
</html>
